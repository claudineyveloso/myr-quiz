<div class="container-fluid bg-title-result-quiz">
  <div class="container">
    <div class="row align-items-center">
      <div class="col-md-6 col-12">
        <%= image_tag 'marca-myr.png', class: "img-fluid h-100 mb-4 w-270 img-myr-tech-result-quiz mt-4", data: { aos: "fade-down", aos_duration: "1000" }, alt: "Myr-tech" %>
      </div>
      <div class="col-md-6 col-12 text-center fs-20">
        <h4>Calculadora ESG</h4>
      </div>
    </div>
  </div>
</div>
<div class="container mt-5">
  <!-- Título Principal -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow text-center">
        <h2 class="text-white bg-title-result-quiz px-3 py-2 m-0 fs-20">Nível Geral</h2>
      </div>

      <div class="card p-4 shadow">
        <h3 class="mt-3 fs-20 text-center" id="maturityName">Estágio 2 | Não Integrado</h3>
        <p class="mt-3 text-center" id="maturityDescription"></p>
        <p class="text-center fs-3rem" id="averageScoreDisplay">2.9</p>
        <div class="text-center d-flex justify-content-center">
          <canvas id="myDoughnutChart" width="350" height="215"></canvas>
        </div>
      </div>
    </div>
  </div>
  <!-- Resultado por Eixo -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow text-center">
        <h2 class="text-white bg-title-result-quiz px-3 py-2 m-0 fs-20">Resultado por eixo</h2>
      </div>

      <div class="card p-4 shadow">
        <div class="row">
          <!-- Legenda (E, S, G) -->
          <div class="col-12 col-md-4 d-flex justify-content-center align-items-center">
            <div class="d-flex flex-column align-items-start">
              <div class="d-flex align-items-center mb-2">
                <span class="legend-box bg-yellow me-2"></span> Ambiental
              </div>
              <div class="d-flex align-items-center mb-2">
                <span class="legend-box bg-teal me-2"></span> Social
              </div>
              <div class="d-flex align-items-center">
                <span class="legend-box bg-purple me-2"></span> Governaça
              </div>
            </div>
          </div>
          <!-- Gráfico (col-8) -->
          <div class="col-12 col-md-8">
            <div class="chart-container" style="position: relative;">
              <canvas id="myChart" class="chart-axi"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Resultado por Tema -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow text-center">
        <h2 class="text-white bg-title-result-quiz px-3 py-2 m-0 fs-20">Resultado por Tema</h2>
      </div>
      <div class="card p-4 shadow">
        <div class="row chart-row">
          <!-- Gráfico 1 -->
          <div class="col-12 col-lg-4 d-flex justify-content-center align-items-center line-chart">
            <div class="chart-container" style="position: relative;">
              <canvas id="myChartEnvironmental" class="chart-by-themes"></canvas>
            </div>
          </div>
          <!-- Gráfico 2 -->
          <div class="col-12 col-lg-4 d-flex justify-content-center align-items-center line-chart">
            <div class="chart-container" style="position: relative;">
              <canvas id="myChartSocial" class="chart-by-themes"></canvas>
            </div>
          </div>
          <!-- Gráfico 3 -->
          <div class="col-12 col-lg-4 d-flex justify-content-center align-items-center line-chart">
            <div class="chart-container" style="position: relative;">
              <canvas id="myChartGovernance" class="chart-by-themes"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
    <!-- Próximos Passos -->
  <div class="row mt-4">
    <div class="col-12">
      <div class="card shadow text-center">
        <h2 class="text-white bg-title-result-quiz px-3 py-2 m-0 fs-20">Próximos Passos</h2>
      </div>
      <div class="card p-4 shadow">
        <div class="row">
          <% @messages.each do |message_data| %>
            <div class="col-12 col-md-4 mb-4">
              <div class="card h-100">
                <div class="card-body" style="background-color: <%= message_data[:color_code] %>;">
                  <h5 class="card-title"><%= message_data[:message].axi.name %></h5>
                  <p class="card-text"><%= message_data[:message].message %></p>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <div class="row mt-4 mb-4">
    <div class="text-center d-flex justify-content-center chart-row">
      <div class="col-12 col-lg-4 d-flex justify-content-center align-items-center">
        <button type="button" class="btn-result-quiz btn-sm h-54 w-350" onclick="window.open('https://grupomyr.com.br/blog/', '_blank')">
          Conheça mais sobre a Comissão <br> de Compliance e ESG
        </button>
      </div>
      <div class="col-12 col-lg-4 d-flex justify-content-center align-items-center">
        <button type="button" class="btn-result-quiz btn-sm h-54 w-350" onclick="window.open('https://grupomyr.com.br/contato/', '_blank')">
          Entre em contato conosco
        </button>
      </div>
      <div class="col-12 col-lg-4 d-flex justify-content-center align-items-center">
        <%= button_to "Gerar PDF", result_quizzes_path(@result, format: :pdf), method: :get, class: "btn-result-quiz btn-sm h-54 w-350" %>
      </div>
    </div>
  </div>
</div>

<script>
  // Função para buscar os dados via JSON
  async function fetchResults(customerId) {
    const response = await fetch(`/result_quizzes?customer_id=${customerId}`, {
      headers: {
        "Accept": "application/json" // Adiciona o cabeçalho para especificar que espera JSON
      }
    });

    // Verifica se a resposta está ok
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }

    const results = await response.json();
    console.log('results', results); // Log dos resultados para depuração
    return results;
  }

  // Função para gerar o gráfico
  async function generateChart() {

    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    const customerId = getCookie('customer_id');
    try {
      const results = await fetchResults(parseInt(customerId));
      
      document.getElementById('maturityName').textContent = results.maturity_name; // Atualiza o nome da maturidade
      document.getElementById('maturityDescription').textContent = results.maturity_description; // Atualiza o nome da maturidade
      document.getElementById('averageScoreDisplay').textContent = (Math.floor((results.total_average_score / 3) * 10) / 10).toFixed(1) + " / 5.0"; // Atualiza o valor


      const labels = results.results.map(result => result.results.axi_name); // Rótulos do gráfico
      const data = results.results.map(result => result.results.average_score); // Valores

      // Gera o gráfico
      new Chart(document.getElementById('myChart').getContext('2d'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [{
            label: '',
            data: data,
            backgroundColor: ['rgba(219, 221, 133, 1)', 'rgba(2, 116, 127, 1)', 'rgba(155, 91, 148, 1)'],
            borderColor: ['rgba(219, 221, 133, 1)', 'rgba(2, 116, 127, 1)', 'rgba(155, 91, 148, 1)'],
            borderWidth: 1,
            barThickness: 80
          }]
        },
        options: {
          responsive: false,
          plugins: {
            legend: {
              display: false
            },
            datalabels: { // Adiciona a configuração do plugin
              color: '#fff', // Cor do texto dos rótulos
              anchor: 'center', // Posiciona os rótulos ao centro da barra
              align: 'center', // Alinha os rótulos ao centro da barra
              font: {
                weight: '400'
              },
              formatter: (value, context) => {
                // const index = context.dataIndex; // Índice da barra
                // const label = context.chart.data.labels[index]; // Descrição (label) correspondente
                // return `${label}:\n${value}`; // Exibe o valor dentro da barra
                return value;
              }
            }
          },
          scales: {
            y: { 
              beginAtZero: true,
              min: 0,
              max: 5,
            },
            x: { ticks: { display: false } }
          }
        },
        plugins: [ChartDataLabels]
      });
    } catch (error) {
      console.error('Error generating chart:', error);
    }
  }

  // Chama a função para gerar o gráfico
  generateChart();
</script>

<script>
  function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }

    const customerId = getCookie('customer_id');

    fetch(`/result_quizzes.json?customer_id=${customerId}`, {
    method: 'GET',
    headers: {
      'Content-Type': 'application/json'
    }
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.json();
  })
  .then(data => {
    const totalAverageScore = data.total_average_score; // Obtém a soma das médias do JSON
    console.log('valor de totalAverageScore', totalAverageScore/3)
    console.log('Nome da maturidade', maturityName)
    // const remainingScore = 6 - totalAverageScore; // Calcula o restante até 6
    const remainingScore = 5; // Calcula o restante até 6

    const ctxGeral = document.getElementById('myDoughnutChart').getContext('2d');

    new Chart(ctxGeral, {
      type: 'doughnut',
      data: {
        datasets: [{
          label: 'Média de Desempenho',
          data: [(totalAverageScore/3).toFixed(2), remainingScore], // Usa os dados dinâmicos
          backgroundColor: [
            'rgba(75, 192, 192, 0.6)', // Cor para a média
            'rgba(192, 192, 192, 0.6)'  // Cor para o restante
          ],
          borderColor: [
            'rgba(75, 192, 192, 1)',
            'rgba(192, 192, 192, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: false,
        maintainAspectRatio: false,
        plugins: {
          tooltip: {
            callbacks: {
              label: function(tooltipItem) {
                return tooltipItem.label + ': ' + tooltipItem.raw;
              }
            }
          }
        }
      }
    });
  })
  .catch(error => {
    console.error('There was a problem with the fetch operation:', error);
  });

</script>

<script>
  // Passando os dados do Rails para o JavaScript como JSON
  const axisEnvironmental = <%= @axis_environmental.to_json.html_safe %>;
  const axisSocial = <%= @axis_social.to_json.html_safe %>;
  const axisGovernance = <%= @axis_governance.to_json.html_safe %>;

  function createChart(ctx, labels, datasetLabel, data, backgroundColors, borderColors) {

    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: datasetLabel,
          data: data,
          backgroundColor: backgroundColors,
          borderColor: borderColors,
          borderWidth: 1,
          barThickness: 50,
          barThickness: 30,
          maxBarThickness: 20
        }]
      },
      options: {
        indexAxis: 'y',
        responsive: false,
        plugins: {
          legend: {
            display: false // Oculta a legenda
          },
          datalabels: {
            anchor: 'center',
            align: 'center',
            color: '#fff',
            font: {
              weight: '400',
            },
            formatter: function(value, context) {
              return value; // Exibe o valor diretamente nas barras
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            min: 0,
            max: 5,
            grid: {
              display: false
            },
            ticks: {
              color: '#000'
            }
          },
          x: {
            grid: {
              display: false
            },
            ticks: {
              display: false
            },
            border: {
              display: true
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });
  }

  // Labels para os temas (extraindo de axisEnvironmental, axisSocial e axisGovernance)
  const labelsEnvironmental = axisEnvironmental.map(theme => theme.theme_name);
  const labelsSocial = axisSocial.map(theme => theme.theme_name);
  const labelsGovernance = axisGovernance.map(theme => theme.theme_name);


  // Cores para os gráficos
  const backgroundColorsEnvironmental = ['rgba(219, 221, 133, 1)', 'rgba(219, 221, 133, 1)', 'rgba(219, 221, 133, 1)', 'rgba(219, 221, 133, 1)', 'rgba(219, 221, 133, 1)', 'rgba(219, 221, 133, 1)'];
  const backgroundColorsSocial = ['rgba(2, 116, 127, 1)', 'rgba(2, 116, 127, 1)', 'rgba(2, 116, 127, 1)', 'rgba(2, 116, 127, 1)', 'rgba(2, 116, 127, 1)', 'rgba(2, 116, 127, 1)'];
  const backgroundColorsGovernance = ['rgba(155, 91, 148, 1)', 'rgba(155, 91, 148, 1)', 'rgba(155, 91, 148, 1)', 'rgba(155, 91, 148, 1)', 'rgba(155, 91, 148, 1)', 'rgba(155, 91, 148, 1)'];


  const borderColorsEnvironmental = ['rgba(219, 221, 133, 1)', 'rgba(219, 221, 133, 1)', 'rgba(219, 221, 133, 1)', 'rgba(219, 221, 133, 1)', 'rgba(219, 221, 133, 1)', 'rgba(219, 221, 133, 1)'];
  const borderColorsSocial = ['rgba(2, 116, 127, 1)', 'rgba(2, 116, 127, 1)', 'rgba(2, 116, 127, 1)', 'rgba(2, 116, 127, 1)', 'rgba(2, 116, 127, 1)', 'rgba(2, 116, 127, 1)'];
  const borderColorsGovernance = ['rgba(155, 91, 148, 1)', 'rgba(155, 91, 148, 1)', 'rgba(155, 91, 148, 1)', 'rgba(155, 91, 148, 1)', 'rgba(155, 91, 148, 1)', 'rgba(155, 91, 148, 1)'];

  // Criar gráficos para cada eixo (ambiental, social, governança)
  
  // Gráfico Ambiental
  const ctxEnvironmental = document.getElementById('myChartEnvironmental').getContext('2d');
  const environmentalScores = axisEnvironmental.map(theme => theme.average_score); // extrai os valores de `average_score`
  createChart(ctxEnvironmental, labelsEnvironmental, 'Resultado Ambiental', environmentalScores, backgroundColorsEnvironmental, borderColorsEnvironmental);

  // Gráfico Social
  const ctxSocial = document.getElementById('myChartSocial').getContext('2d');
  const socialScores = axisSocial.map(theme => theme.average_score);
  createChart(ctxSocial, labelsSocial, 'Resultado Social', socialScores, backgroundColorsSocial, borderColorsSocial);

  // Gráfico Governança
  const ctxGovernance = document.getElementById('myChartGovernance').getContext('2d');
  const governanceScores = axisGovernance.map(theme => theme.average_score);
  createChart(ctxGovernance, labelsGovernance, 'Resultado Governança', governanceScores, backgroundColorsGovernance, borderColorsGovernance);

</script>
